<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SchedAssistant - Main</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Icons -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        .logo {
            width: 120px;
            height: 120px;
            object-fit: contain;
        }

        html,
        body {
            height: 100%;
            overflow: auto;
            overscroll-behavior: none;
            font-family: "Poppins", sans-serif;
            background-color: beige;
        }

        .sidebar {
            min-width: 300px;
            max-width: 320px;
            width: 300px;
        }

        .sidebar-links h6 {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #adb5bd;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .sidebar-links li a {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border-radius: 6px;
            color: #fff;
            transition: background 0.2s ease-in-out;
            font-weight: 600;
        }

        .sidebar-links li a:hover {
            background-color: #0d6efd;
            text-decoration: none;
        }

        .btn-success {
            background-color: #4a7d7d !important;
            border-color: #4a7d7d !important;
        }

        .btn-success:hover {
            background-color: #3b6666 !important;
            border-color: #3b6666 !important;
        }

        main {
            background-color: #f5f0e6;
            flex-grow: 1;
            padding: 20px;
            overflow: auto;
        }

        /* Windows Grid Fix */
        .windows-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            margin-bottom: 20px;
        }

        .windows-grid .task-block {
            width: 100%;
            height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 15px;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .windows-grid .task-block .task-count {
            font-size: 3.5rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 5px;
        }

        .windows-grid .task-block .task-label {
            font-size: 0.9rem;
            font-weight: 500;
            line-height: 1.2;
        }

        /* Schedule Grid Fix */
        .schedule-outer-container {
            display: flex;
            align-items: flex-start;
            gap: 5px;
            width: 100%;
            /* Remove explicit min-width/max-content if scroll-container handles it */
        }

        .time-column-standalone {
            min-width: 80px;
            max-width: 80px;
            background: #f8f9fa;
            border-radius: 10px 0px 0px 0px;
            overflow: hidden;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.05);
        }

        .time-column-standalone .time-header-sticky {
            position: sticky;
            top: 0;
            z-index: 20;
            padding: 6px 0;
            text-align: center;
            font-weight: 600;
            border-bottom: 1px solid #ccc;
            background-color: #343a40 !important;
            color: #fff !important;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

	/* Completed task styling */
.task-block.completed-task {
    opacity: 0.6;
    filter: grayscale(0.7);
    background-color: #e9ecef !important;
    color: #6c757d !important;
    border: 1px dashed #6c757d !important;
    text-decoration: line-through;
}

.task-block.completed-task:hover {
    opacity: 0.8;
    filter: grayscale(0.5);
}

.completed-check {
    font-weight: bold;
    margin-left: 4px;
    font-size: 0.9em;
}

/* Keep the original category colors but faded */
.task-block.completed-task.Education {
    background-color: rgba(74, 125, 125, 0.3) !important;
}

.task-block.completed-task.Work {
    background-color: rgba(220, 53, 69, 0.3) !important;
}

.task-block.completed-task.Personal {
    background-color: rgba(255, 193, 7, 0.3) !important;
}

.task-block.completed-task.Health {
    background-color: rgba(25, 135, 84, 0.3) !important;
}

        .time-column-standalone .time-label {
            height: 31px;
            /* Changed to match 30-minute slot height */
            padding: 5px;
            text-align: center;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: 50px repeat(64, 15px);
            /* 1 header row + 32 slots * 30px height */
            gap: 1px;
            background-color: #ddd;
            border: 1px solid #ddd;
            width: 100%;
            border-radius: 0px 10px 0px 0px;
            flex-grow: 1;
            position: relative;
            z-index: 1;
            min-width: 700px;
            /* Minimum width for the grid content to prevent squishing */
        }

        .day-label {
            text-align: center;
            font-weight: 600;
            padding: 6px 0;
            border-bottom: 1px solid #ccc;
            position: sticky;
            top: 0;
            z-index: 15;
            background-color: #343a40;
            color: white;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Ensure day labels have a fixed width or can shrink */
            width: 100%;
            /* Occupy full column width */
        }

        .grid-cell {
            background: white;
            border-bottom: 1px solid #eee;
            position: relative;
            z-index: 1;
            height: 15px;
            /* Match slot height */
        }

        /* Task Blocks */
        .task-block {
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s ease-in-out;
            color: white;
            padding: 4px 3px;
            /* Adjusted padding for smaller slots */
            border-radius: 4px;
            /* Adjusted border-radius */
            font-size: 0.7rem;
            /* Adjusted font size */
            font-weight: 600;
            display: flex;
            flex-direction: column;
            justify-content: center;
            z-index: 1;
            margin: 1px;
            overflow: hidden;
            position: relative;
            z-index: 2;
            margin: 1px 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.2;
        }

        .task-block:hover {
            z-index: 3;
            /* Even higher on hover */
        }

        .task-block.selected {
            border: 2px solid #007bff;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
            transform: scale(1.02);
            z-index: 10;
        }

        .task-block.Education {
            background-color: #4a7d7d;
        }

        .task-block.Work {
            background-color: #dc3545;
        }

        .task-block.Personal {
            background-color: #ffc107;
            color: #333;
        }

        .task-block.Health {
            background-color: #198754;
        }

        .task-block.score-critical {
            background-color: #dc3545;
        }

        .task-block.score-high {
            background-color: #ffc107;
            color: #333;
        }

        .task-block.score-medium {
            background-color: #fd7e14;
        }

        .task-block.score-low {
            background-color: #198754;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #notificationContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .alert-notification {
            background: #6c63ff;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-weight: 600;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 300px;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes urgent-pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-3px);
            }

            75% {
                transform: translateX(3px);
            }
        }


        .urgent-task {
            border: 2px solid #dc3545 !important;
            box-shadow: 0 0 8px rgba(220, 53, 69, 0.5) !important;
        }

        .overdue-task {
            border: 3px solid #dc3545 !important;
            background: repeating-linear-gradient(45deg,
                    transparent,
                    transparent 10px,
                    rgba(220, 53, 69, 0.1) 10px,
                    rgba(220, 53, 69, 0.1) 20px) !important;
        }

        .calendar-scroll-container {
            width: 100%;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 100vh;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .calendar-scroll-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .calendar-scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .calendar-scroll-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .calendar-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .custom-alert {
   
    background: linear-gradient(135deg, #30c5d2, #471069);
        font-weight: bold;
        color: white;
        }


        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translateY(-10px);
            }

            10%,
            90% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        .pulsing {
            animation: pulse 1s infinite;
        }

        /* Layout fixes */
        .main-content-wrapper {
            display: flex;
            gap: 20px;
            width: 100%;
        }

        .left-panel {
            min-width: 300px;
            flex-shrink: 0;
        }

        .right-panel {
            flex-grow: 1;
            min-width: 0;
        }
    </style>

</head>

<body class="bg-beige">

    <!-- Notification Container -->
    <div id="notificationContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

    <div class="d-flex">
        <!-- Sidebar -->
        <aside class="sidebar bg-dark text-white p-3">
            <div class="sidebar-header text-center mb-4">
                <img src="{{ url_for('static', filename='icon/Icon.png') }}" alt="SchedAssist logo" class="logo">
                <h2 class="h5">SchedAssistant</h2>
            </div>
            <ul class="list-unstyled sidebar-links">
                <h6 class="text-uppercase">Main Menu</h6>
                <li class="mb-2"><a href="{{ url_for('dashboard') }}" class="text-white text-decoration-none"><span
                            class="material-symbols-outlined">dashboard</span>Dashboard</a></li>
                <li class="mb-2"><a href="{{ url_for('schedule') }}" class="text-white text-decoration-none"><span
                            class="material-symbols-outlined">calendar_month</span>Schedule</a></li>
                <li class="mb-2"><a href="{{ url_for('analytics') }}" class="text-white text-decoration-none"><span
                            class="material-symbols-outlined">monitoring</span>Analytics</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="flex-grow-1 p-5 text-dark">
            <h2>Weekly Tasks</h2>
            <p><strong>{{ formatted_date }}</strong> | Week {{ week_number }}</p>


            {% if advice_text and advice_text.strip() %}
            <div id="personalizedAdviceAlert" class="alert custom-alert alert-dismissible fade show mb-4" role="alert">
                <h4 class="alert-heading" style="font-weight: bold;">Personalized Advice</h4>
                {{ advice_text }}
            </div>
            {% endif %}

            <div class="main-content-wrapper">
                <!-- Left Panel -->
                <aside class="bg-beige text-dark p-4 left-panel">
                    <h3 class="mt-3">You have...</h3>
                    <hr class="bg-secondary">
                    <div class="windows-grid">
                        <div class="task-block score-critical">
                            <span class="task-count">{{ urgent_count }}</span>
                            <span class="task-label">Urgent Task{{ 's' if urgent_count != 1 }}</span>
                        </div>
                        <div class="task-block score-high">
                            <span class="task-count">{{ important_count }}</span>
                            <span class="task-label">Important Task{{ 's' if important_count != 1 }}</span>
                        </div>
                        <div class="task-block score-medium">
                            <span class="task-count">{{ normal_count }}</span>
                            <span class="task-label">Normal Task{{ 's' if normal_count != 1 }}</span>
                        </div>
                        <div class="task-block score-low">
                            <span class="task-count">{{ unessential_count }}</span>
                            <span class="task-label">Unessential Task{{ 's' if unessential_count != 1 }}</span>
                        </div>
                    </div>

                    <div class="bg-dark text-light p-4 mt-3" style="min-width: 250px; max-width: 300px;">
                        <!-- Adjusted width -->
                        <h6>Weekly Actions</h6>
                        <button id="taskHierarchyBtn" class="btn btn-success mt-3 w-100" data-bs-toggle="modal"
                            data-bs-target="#taskHierarchyModal">Task Hierarchy</button>
                        <button id="markCompletedBtn" class="btn btn-success mt-3 w-100" disabled>Mark Completed</button>
                        <button id="deleteTaskBtn" class="btn btn-success mt-3 w-100" disabled>Delete Task</button>
                    </div>

                    <div id="selectedTaskDetails" class="bg-light text-dark p-3 mt-3 rounded">
                        <small class="text-muted">Click a task to see details.</small>
                    </div>
                </aside>

                <div class="right-panel">
                    <div class="calendar-scroll-container">
                        <div class="schedule-outer-container">
                            <!-- Time Column -->
                            <div class="time-column-standalone">
                                <div class="day-label bg-dark text-white time-header-sticky">Time</div>
                                {% for i in range(16) %}
                                {% set hour = 6 + i %}
                                <div class="time-label">{{ "%02d:00"|format(hour) }}</div>
                                <div class="time-label">{{ "%02d:30"|format(hour) }}</div>
                                {% endfor %}
                            </div>

                            <!-- Schedule Grid -->
                            <div class="schedule-grid">
                                <!-- Day Labels -->
                                {% set day_columns = {'Monday': 1, 'Tuesday': 2, 'Wednesday': 3, 'Thursday': 4,
                                'Friday': 5, 'Saturday': 6, 'Sunday': 7} %}

                                {% for day in ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday']
                                %}
                                <div class="day-label" style="grid-column: {{ day_columns[day] }}; grid-row: 1;">{{ day
                                    }}</div>
                                {% endfor %}

                                <!-- Grid cells -->

                                {% for i in range(64) %} {# 64 slots for 16 hours * 4 (15-minute intervals) #}
                                {% set current_grid_row = i + 2 %} {# +2 because grid-row starts after header #}
                                {% for day in ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday']
                                %}
                                <div class="grid-cell"
                                    style="grid-column: {{ day_columns[day] }}; grid-row: {{ current_grid_row }};">
                                </div>
                                {% endfor %}
                                {% endfor %}
                                <!-- Tasks -->
                                <!-- Corrected Jinja2 task block -->
                               <!-- In the task block section -->
{% for task in tasks %}
{% if task.weekday and task.start_hour_int is defined and task.end_hour_int is defined %}
{% set start_minutes_from_6am = (task.start_hour_int - 6) * 60 + task.start_minute_int %}
{% set duration_minutes = task.duration | default(60) %}

{# Calculate grid positions with 15-minute precision #}
{% set start_slot_index = (start_minutes_from_6am // 15) + 1 %}
{% set num_slots = (duration_minutes + 14) // 15 %}
{% set num_slots = num_slots if num_slots > 0 else 1 %}

{% set day_col = day_columns[task.weekday] %}
<div class="task-block {{ task.category }} 
    {% if task.completed %}completed-task{% endif %}
    {% if task.score >= 70 %}score-critical
    {% elif task.score >= 40 %}score-high
    {% elif task.score >= 10 %}score-medium
    {% else %}score-low{% endif %}"
    style="grid-column: {{ day_col }}; grid-row: {{ start_slot_index }} / span {{ num_slots }};"
    data-task-id="{{ task.id }}" data-title="{{ task.title }}"
    data-deadline="{{ task.deadline }}"
    data-reminders='{{ task.reminders | default("[]") }}' data-score="{{ "
    %.1f"|format(task.score|float) }}" data-start-time="{{ task.start_hour_str }}"
    data-end-time="{{ task.end_hour_str }}" data-category="{{ task.category }}"
    data-duration="{{ task.duration | default(60) }}"
    {% if task.completed %}data-completed="true"{% endif %}>
    {{ task.title }}
    {% if task.completed %}<span class="completed-check">‚úì</span>{% endif %}
</div>
{% endif %}
{% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="taskHierarchyModal" tabindex="-1" aria-labelledby="taskHierarchyModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskHierarchyModalLabel">Task Hierarchy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">Loading tasks...</div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ML-Powered Notification System
class MLNotificationManager {
    constructor() {
        const stored = JSON.parse(localStorage.getItem('shownNotifications') || '[]');
        this.shownNotifications = new Set(stored);
        this.mlData = null;
        this.checkMLNotifications();
    }

    async checkMLNotifications() {
        try {
            console.log('üß† Checking for notifications...');
            const [notificationsResponse] = await Promise.all([
                fetch('/api/notifications')
            ]);
            if (!notificationsResponse.ok) throw new Error(`Failed to fetch notifications: ${notificationsResponse.statusText}`);

            const basicNotifications = await notificationsResponse.json();

            basicNotifications.forEach(notification => {
                const notificationId = `basic_${notification.task_id}_${notification.type}`;
                if (!this.shownNotifications.has(notificationId)) {
                    this.showBasicNotification(notification);
                    this.shownNotifications.add(notificationId);
                }
            });

            localStorage.setItem('shownNotifications', JSON.stringify([...this.shownNotifications]));

        } catch (error) {
            console.error('Notifications check failed:', error);
        }
    }

    showBasicNotification(notification) {
        const config = {
            'reminder': { icon: '‚è∞', type: 'warning' },
            'urgency': { icon: 'üö®', type: 'error' },
            'overdue': { icon: 'üî¥', type: 'error' }
        };
        const cfg = config[notification.type] || config.reminder;

        this.showAlert(
            `${cfg.icon} ${notification.message}`,
            cfg.type,
            `basic_${notification.task_id}_${notification.type}` // Pass the unique ID
        );
        this.updateTaskVisual(notification);
    }

    showAlert(msg, type = 'info', notificationId = null) {
        const alertBox = document.createElement('div');
        const styles = {
            'info': { background: '#6c63ff', icon: '‚ÑπÔ∏è' },
            'success': { background: '#198754', icon: '‚úÖ' },
            'warning': { background: '#ffc107', icon: '‚ö†Ô∏è', color: '#333' },
            'error': { background: '#dc3545', icon: '‚ùå' }
        };
        const style = styles[type] || styles['info'];

        alertBox.className = 'alert-notification';
        if (notificationId) {
            // Add a data-attribute to find this alert later
            alertBox.dataset.notificationId = notificationId;
        }

        alertBox.style.cssText = `
            background: ${style.background};
            color: ${style.color || 'white'};
            /* ... other styles remain the same ... */
            padding: 15px 20px;
            border-radius: 10px;
            font-weight: 600;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 300px;
            animation: slideInRight 0.3s ease-out;
        `;
        alertBox.innerHTML = `
            <span style="font-size: 1.2em;">${style.icon}</span>
            <span style="flex-grow: 1;">${msg}</span>
            <button class="close-notification" style="background: none; border: none; color: inherit; cursor: pointer; font-size: 1.2em;">&times;</button>
        `;

        document.getElementById('notificationContainer').appendChild(alertBox);

        const closeButton = alertBox.querySelector('.close-notification');
        closeButton.addEventListener('click', () => {
            if (notificationId) {
                this.shownNotifications.add(notificationId);
                localStorage.setItem('shownNotifications', JSON.stringify([...this.shownNotifications]));
            }
            alertBox.remove();
        });

        // *** CHANGE 1: REMOVED THE AUTOMATIC TIMEOUT ***
        // The alert will now stay until the user clicks the close button.
    }

    updateTaskVisual(notification) {
        if (!notification.task_id) return;
        const taskElement = document.querySelector(`[data-task-id="${notification.task_id}"]`);
        if (taskElement) {
            taskElement.classList.remove('urgent-task', 'overdue-task');
            if (notification.type === 'urgency' || notification.type === 'error') {
                taskElement.classList.add('urgent-task');
            } else if (notification.type === 'overdue') {
                taskElement.classList.add('overdue-task');
            }
            taskElement.classList.add('pulsing');
            setTimeout(() => taskElement.classList.remove('pulsing'), 5000);
        }
    }

    clearTaskNotifications(taskId) {
        // *** CHANGE 2: ENHANCED LOGIC TO REMOVE NOTIFICATIONS ***
        
        // 1. Remove from data source (localStorage)
        const notificationsToRemove = [];
        for (const notificationId of this.shownNotifications) {
            if (notificationId && notificationId.includes(`_${taskId}_`)) {
                notificationsToRemove.push(notificationId);
            }
        }
        if (notificationsToRemove.length > 0) {
            notificationsToRemove.forEach(id => this.shownNotifications.delete(id));
            localStorage.setItem('shownNotifications', JSON.stringify([...this.shownNotifications]));
            console.log(`Cleared notifications for task ${taskId} from storage.`);
        }

        // 2. Remove from the DOM (the visible alerts)
        const notificationContainer = document.getElementById('notificationContainer');
        if (notificationContainer) {
            const activeAlerts = notificationContainer.querySelectorAll('.alert-notification');
            activeAlerts.forEach(alert => {
                const alertId = alert.dataset.notificationId;
                if (alertId && alertId.includes(`_${taskId}_`)) {
                    alert.remove();
                    console.log(`Removed visible alert ${alertId} from DOM.`);
                }
            });
        }
    }
}

// Global function for simple alerts (like success messages)
function showAlert(msg, type = 'info') {
    const alertBox = document.createElement('div');
    const styles = {
        'info': { background: '#6c63ff', icon: '‚ÑπÔ∏è' },
        'success': { background: '#198754', icon: '‚úÖ' },
        'warning': { background: '#ffc107', icon: '‚ö†Ô∏è', color: '#333' },
        'error': { background: '#dc3545', icon: '‚ùå' }
    };
    const style = styles[type] || styles['info'];
    alertBox.className = 'alert-notification';
    alertBox.style.cssText = `
        background: ${style.background}; color: ${style.color || 'white'}; padding: 15px 20px;
        border-radius: 10px; font-weight: 600; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        display: flex; align-items: center; gap: 10px; max-width: 300px; animation: slideInRight 0.3s ease-out;
    `;
    alertBox.innerHTML = `
        <span style="font-size: 1.2em;">${style.icon}</span>
        <span style="flex-grow: 1;">${msg}</span>
        <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer; font-size: 1.2em;">&times;</button>
    `;
    document.getElementById('notificationContainer').appendChild(alertBox);

    // *** Also removed automatic timeout from this global function ***
}

// Main DOM Content Loaded
document.addEventListener('DOMContentLoaded', () => {
    let selectedTaskId = null;
    const markCompletedBtn = document.getElementById('markCompletedBtn');
    const deleteTaskBtn = document.getElementById('deleteTaskBtn');
    const selectedTaskDetailsContainer = document.getElementById('selectedTaskDetails');
    
    // Initialize notification manager
    const notificationManager = new MLNotificationManager();

    function updateActionButtons() {
        markCompletedBtn.disabled = !selectedTaskId;
        deleteTaskBtn.disabled = !selectedTaskId;
    }

    function updateSelectedTaskDetailsDisplay() {
        if (selectedTaskId) {
            const selectedBlock = document.querySelector(`.task-block[data-task-id="${selectedTaskId}"]`);
            if (selectedBlock) {
                 const title = selectedBlock.dataset.title || 'No title';
                const score = selectedBlock.dataset.score || '0';
                const startTime = selectedBlock.dataset.startTime || 'Unknown';
                const endTime = selectedBlock.dataset.endTime || 'Unknown';
                const category = selectedBlock.dataset.category || 'Unknown';
                const duration = selectedBlock.dataset.duration || '0';
                
                let deadlineText = 'Unknown';
                try {
                    const deadline = new Date(selectedBlock.dataset.deadline);
                    if (!isNaN(deadline.getTime())) {
                        deadlineText = deadline.toLocaleDateString('en-US', { 
                            year: 'numeric', month: 'long', day: 'numeric',
                            hour: '2-digit', minute: '2-digit'
                        });
                    }
                } catch (e) { /* ignore */ }

                selectedTaskDetailsContainer.innerHTML = `
                    <h6>Selected Task Details:</h6> <strong>${title}</strong><br>
                    <small>Category: ${category}</small><br> <small>Time: ${startTime} - ${endTime}</small><br>
                    <small>Duration: ${duration} minutes</small><br> <small>Priority Score: ${score}</small><br>
                    <small>Deadline: ${deadlineText}</small>
                `;
            }
        } else {
            selectedTaskDetailsContainer.innerHTML = '<small class="text-muted">Click a task to see details.</small>';
        }
    }

    document.querySelector('.schedule-grid').addEventListener('click', function (event) {
        let targetBlock = event.target.closest('.task-block');
        if (targetBlock) {
            const taskId = targetBlock.dataset.taskId;
            if (selectedTaskId === taskId) {
                document.querySelectorAll('.task-block.selected').forEach(b => b.classList.remove('selected'));
                selectedTaskId = null;
            } else {
                document.querySelectorAll('.task-block.selected').forEach(b => b.classList.remove('selected'));
                targetBlock.classList.add('selected');
                selectedTaskId = taskId;
            }
            updateActionButtons();
            updateSelectedTaskDetailsDisplay();
        }
    });

markCompletedBtn.addEventListener('click', async () => {
    if (selectedTaskId && confirm('Mark this task as completed?')) {
        const response = await fetch(`/mark_completed/${selectedTaskId}`, { method: 'POST' });
        if (response.ok) {
            notificationManager.clearTaskNotifications(selectedTaskId);
            showAlert('‚úÖ Task marked as completed!', 'success');
            
            // Update the task visually without reloading
            const taskBlock = document.querySelector(`.task-block[data-task-id="${selectedTaskId}"]`);
            if (taskBlock) {
                taskBlock.classList.add('completed-task');
                taskBlock.dataset.completed = "true";
                taskBlock.innerHTML = `${taskBlock.dataset.title} <span class="completed-check">‚úì</span>`;
            }
            
            // Deselect the task and update UI
            selectedTaskId = null;
            updateActionButtons();
            updateSelectedTaskDetailsDisplay();
            
            // Remove the page reload
            
        }
    }
});
    deleteTaskBtn.addEventListener('click', async () => {
        if (selectedTaskId && confirm('Delete this task? This cannot be undone!')) {
            const response = await fetch(`/delete_task/${selectedTaskId}`, { method: 'POST' });
            if (response.ok) {
                // This now removes the visible alert and updates storage
                notificationManager.clearTaskNotifications(selectedTaskId);
                showAlert('üóëÔ∏è Task deleted!', 'success');
                setTimeout(() => window.location.reload(), 1000);
            }
        }
    });

    document.getElementById('taskHierarchyBtn').addEventListener('click', async () => {
        const modalBody = document.querySelector('#taskHierarchyModal .modal-body');
        modalBody.innerHTML = 'Loading tasks...';
        const response = await fetch('/get_task_hierarchy_modal_content');
        if (response.ok) {
            modalBody.innerHTML = await response.text();
        }
    });

    // Initialize page state
    updateActionButtons();
    updateSelectedTaskDetailsDisplay();
});
    </script>
</body>

</html>