<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - SchedAssistant</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Icons -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        .bg-beige {
            background-color: beige;
        }

        .logo {
            width: 120px;
            height: 120px;
            object-fit: contain;
        }

        body {
            overflow: auto;
        }

        .card {
            width: 100%;
            max-width: 800px;
        }

        .welcome-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .insight-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #4a7d7d;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .task-block {
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s ease-in-out;
            color: black;
            padding: 20px;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            line-height: 1.5;
        }

        .ward {
            width: 300px;
            height: 450px;
            background-color: grey;
            text-align: center;
            color: white;
            font-weight: bold;
            border-radius: 20px;
        }

        div {
            font-weight: 500;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .d-flex {
            height: 130vh;
            width: 100%;
        }

        /* Sidebars */
        .sidebar {
            min-width: 300px;
            max-width: 320px;
            width: 300px;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .sidebar-links h6 {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #adb5bd;
            margin-bottom: 10px;
        }

        .sidebar-links li a {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border-radius: 6px;
            color: #fff;
            transition: background 0.2s ease-in-out;
        }

        .sidebar-links li a:hover {
            background-color: #0d6efd;
            text-decoration: none;
        }

        .sidebar-links li a.active {
            background-color: #0b5ed7;
        }

        .user-avatar {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .progress-sm {
            height: 8px;
        }
    </style>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-beige">
    <div class="d-flex">
        <!-- Sidebar -->
        <aside class="sidebar bg-dark text-white p-3">
            <div class="sidebar-header text-center mb-4">
                <img src="{{ url_for('static', filename='icon/Icon.png') }}"
     			alt="SchedAssist logo" class="logo"
    			 onerror="this.src='{{ url_for('static', filename='icon/Icon-fallback.png') }}'">
                <h2 class="h5">SchedAssistant</h2>
            </div>
            <ul class="list-unstyled sidebar-links">
                <h6 class="text-uppercase">Main Menu</h6>
                <li class="mb-2"><a href="{{ url_for('dashboard') }}"
                        class="text-white text-decoration-none"><span class="material-symbols-outlined">dashboard</span>Dashboard</a>
                </li>
                <li class="mb-2"><a href="{{ url_for('schedule') }}"
                        class="text-white text-decoration-none"><span class="material-symbols-outlined">calendar_month</span>Schedule</a>
                </li>
                <li class="mb-2"><a href="{{ url_for('analytics') }}"
                        class="text-white text-decoration-none"><span class="material-symbols-outlined">monitoring</span>Analytics</a>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="flex-grow-1 p-4">
            <h2>Analytics</h2>
            <p><strong>{{ formatted_date }}</strong> | Week {{ week_number }}</p>

            <!-- Personalized Welcome Card -->
            <div class="welcome-card">
                <div class="row align-items-center">
                    <div class="col-md-2 text-center">
                        <div class="user-avatar" id="userAvatar">ðŸ‘¤</div>
                    </div>
                    <div class="col-md-10">
                        <h4 id="welcomeMessage">Welcome back!</h4>
                        <p id="userInsight" class="mb-0">Checking your productivity patterns...</p>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Left Column: Completed Tasks Graph -->
                <div class="col-md-8">
                    <div class="card mb-4 bg-dark text-white">
                        <div class="card-header">Weekly Completion Rate</div>
                        <div class="card-body">
                            <canvas id="completedTasksChart" height="120"></canvas>
                        </div>
                    </div>

        

                <!-- Right Column: Simple Stats -->
                <div class="col-md-4">
                    <!-- Quick Stats -->
                    <div class="card text-center mb-4">
                        <div class="card-body">
                            <h6>Completed This Week</h6>
                            <h2 id="completedCount">{{ day_counts | sum if day_counts else 0 }}</h2>
                            <small class="text-muted">Total tasks completed</small>
                        </div>
                    </div>

                    <!-- Productivity Tip -->
                    <div class="card">
                        <div class="card-header">ðŸ’¡ Productivity Tip</div>
                        <div class="card-body">
                            <p id="productivityTip" class="small mb-0">
                                Break large tasks into smaller steps for better completion rates!
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Bootstrap & Chart.js Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="text/javascript">
        // Flask â†’ JS data bridge
        const archivedTasks = {{ archived_tasks | default([]) | tojson | safe }};
        const dayLabels = {{ day_labels | tojson | safe }};
        const dayCounts = {{ day_counts | tojson | safe }};
        const categoryLabels = {{ category_labels | tojson | safe }};
        const categoryCounts = {{ counts | tojson | safe }};

        console.log('Analytics Data:', archivedTasks, categoryLabels, categoryCounts);

        // User Behavior Analysis
        class UserBehaviorAnalyzer {
            constructor() {
                this.userType = '';
                this.focusArea = '';
                this.completionTrend = '';
            }

            analyzeUserPatterns() {
                this.determineUserType();
                this.analyzeFocusArea();
                this.analyzeCompletionTrend();
                this.updateUI();
            }

            determineUserType() {
                const now = new Date();
                const currentHour = now.getHours();
                const totalTasks = categoryCounts.reduce((sum, count) => sum + count, 0);
                const workTasks = categoryCounts[categoryLabels.indexOf('Work')] || 0;
                
                if (currentHour < 8) {
                    this.userType = 'early_bird';
                } else if (currentHour > 22) {
                    this.userType = 'night_owl';
                } else if (workTasks > totalTasks * 0.6) {
                    this.userType = 'worker_bee';
                } else {
                    this.userType = 'balanced';
                }
            }

            

            analyzeCompletionTrend() {
                if (dayCounts.length < 2) {
                    this.completionTrend = 'steady';
                    return;
                }
                
                const todayCount = dayCounts[dayCounts.length - 1] || 0;
                const yesterdayCount = dayCounts[dayCounts.length - 2] || 0;
                
                if (todayCount > yesterdayCount * 1.5) {
                    this.completionTrend = 'improving';
                } else if (todayCount < yesterdayCount * 0.7) {
                    this.completionTrend = 'declining';
                } else {
                    this.completionTrend = 'steady';
                }
            }

            updateUI() {
                this.updateWelcomeMessage();
                this.updateFocusInsight();
                this.updateCompletionInsight();
                this.updateProductivityTip();
            }

            updateWelcomeMessage() {
                const avatar = document.getElementById('userAvatar');
                const welcome = document.getElementById('welcomeMessage');
                const insight = document.getElementById('userInsight');
                
                const messages = {
                    'early_bird': { 
                        avatar: 'ðŸŒ…', 
                        welcome: 'Good morning, Early Bird!', 
                        insight: 'Starting your day with analytics - impressive!' 
                    },
                    'night_owl': { 
                        avatar: 'ðŸŒ™', 
                        welcome: 'Still up, Night Owl?', 
                        insight: 'Late night productivity session?' 
                    },
                    'worker_bee': { 
                        avatar: 'ðŸ', 
                        welcome: 'Hey Worker Bee!', 
                        insight: 'You\'ve got a lot on your plate this week!' 
                    },
                    'balanced': { 
                        avatar: 'âš–ï¸', 
                        welcome: 'Welcome back!', 
                        insight: 'Great balance across different areas!' 
                    }
                };
                
                const config = messages[this.userType] || messages.balanced;
                avatar.textContent = config.avatar;
                welcome.textContent = config.welcome;
                insight.textContent = config.insight;
            }

            updateFocusInsight() {
                const focusInsight = document.getElementById('focusInsight');
                const insights = {
                    'Work': 'ðŸ’¼ You got a lot of Work to catch up!',
                    'Education': 'ðŸ“š School\'s piling up, stay focused!',
                    'Personal': 'ðŸ  Got a lot of time for yourself, huh?',
                    'Health': 'ðŸ’ª Taking good care of yourself!',
                    'none': 'ðŸ“ Add some tasks to see your focus areas!'
                };
                
                focusInsight.innerHTML = `<p class="mb-0">${insights[this.focusArea] || 'ðŸŽ¯ You\'re focusing on ' + this.focusArea + ' tasks!'}</p>`;
            }

            updateCompletionInsight() {
                const completionInsight = document.getElementById('completionInsight');
                const progressBar = document.getElementById('completionProgress');
                
                const todayCount = dayCounts[dayCounts.length - 1] || 0;
                const avgCount = dayCounts.length > 0 ? dayCounts.reduce((a, b) => a + b) / dayCounts.length : 0;
                const progressPercent = avgCount > 0 ? Math.min((todayCount / avgCount) * 100, 100) : 0;
                
                const insights = {
                    'improving': `ðŸ“ˆ Looks like you got a lot done today compared to yesterday!`,
                    'declining': `ðŸ“‰ Slow day today? You completed fewer tasks than yesterday.`,
                    'steady': `ðŸ“Š Consistent progress! You're maintaining your completion rate.`
                };
                
                completionInsight.textContent = insights[this.completionTrend] || 'ðŸ“ Track your daily completions!';
                progressBar.style.width = `${progressPercent}%`;
                
                // Color code based on performance
                if (progressPercent > 120) {
                    progressBar.className = 'progress-bar bg-success';
                } else if (progressPercent > 80) {
                    progressBar.className = 'progress-bar bg-info';
                } else {
                    progressBar.className = 'progress-bar bg-warning';
                }
            }

            updateProductivityTip() {
                const tipElement = document.getElementById('productivityTip');
                const tips = [
                    "Break large tasks into smaller steps for better completion rates!",
                    "Schedule your most important tasks during your peak productivity hours.",
                    "Take short breaks between tasks to maintain focus and energy.",
                    "Review your completed tasks at the end of each day to track progress.",
                    "Prioritize tasks based on deadlines and importance to reduce stress."
                ];
                
                const randomTip = tips[Math.floor(Math.random() * tips.length)];
                tipElement.textContent = randomTip;
            }
        }

        // DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ðŸ“ˆ Initializing Analytics Dashboard...');
            
            // Initialize User Behavior Analysis
            const userAnalyzer = new UserBehaviorAnalyzer();
            userAnalyzer.analyzeUserPatterns();
            
            // Initialize charts
            const ctx1 = document.getElementById('completedTasksChart')?.getContext('2d');
            
            // Chart 1: Completed Tasks (Line Chart)
            if (ctx1 && Array.isArray(dayLabels) && Array.isArray(dayCounts)) {
                new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: dayLabels,
                        datasets: [{
                            label: 'Completed Tasks',
                            data: dayCounts,
                            borderColor: '#4a7d7d',
                            backgroundColor: 'rgba(74, 125, 125, 0.2)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { title: { display: true, text: 'Date' }},
                            y: { title: { display: true, text: 'Tasks Completed' }, beginAtZero: true, ticks: { precision: 0 } }
                        }
                    }
                });
            }

            // Chart 2: Task Focus (Pie Chart)
            const focusCtx = document.getElementById('taskFocusChart')?.getContext('2d');
            if (focusCtx && Array.isArray(categoryLabels) && Array.isArray(categoryCounts)) {
                new Chart(focusCtx, {
                    type: 'pie',
                    data: {
                        labels: categoryLabels,
                        datasets: [{
                            data: categoryCounts,
                            backgroundColor: ['#4a7d7d', '#dc3545', '#ffc107', '#198754', '#6f42c1']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }
        });
    </script>
</body>

</html>